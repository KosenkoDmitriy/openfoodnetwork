= render :partial => 'spree/admin/shared/configuration_menu'

- content_for :page_title do
  = t(:accounts_and_billing_settings)

= render 'spree/shared/error_messages', target: @settings

-# - month_options = (0...12).map { |i| Time.now.beginning_of_month - i.months }.map{ |t| [t.strftime("%b %Y"), t.strftime("%b %Y %z")]}

.row{ ng: { app: 'admin.accounts_and_billing_settings' } }
  .twelve.columns.alpha.omega
    = form_for @settings, as: :settings, url: main_app.admin_accounts_and_billing_settings_path, :method => :put do |f|
      %fieldset.no-border-bottom
        %legend Settings
        .field
          = f.label :accounts_distributor_id, t(:accounts_administration_distributor)
          = f.collection_select(:accounts_distributor_id, @distributors, :id, :name, { include_blank: true }, { class: "select2 fullwidth", 'watch-value-as' => "enterprise_id"})

        = f.hidden_field :default_accounts_payment_method_id, value: ''
        = f.hidden_field :default_accounts_shipping_method_id, value: ''
        %div{ 'method-settings-for' => 'enterprise_id' }

        .form-buttons{"data-hook" => "buttons"}
          = button t(:update), 'icon-refresh', value: "update"

%fieldset.no-border-bottom
  %legend Manually Run Tasks
  .row
    .six.columns.alpha.step.text-center

      = form_for :job, url: main_app.start_job_admin_accounts_and_billing_settings_path, method: :post do |f|
        = f.hidden_field :name, value: "update_user_invoices"
        -# = f.select :start, options_for_select(month_options), {}, class: "fullwidth select2"
        .form-buttons{"data-hook" => "buttons"}
          = button "Update User Invoices", "icon-undo button fullwidth", :submit, disabled: @update_user_invoices_job.present?

      %br

      - if @update_user_invoices_job
        %p.text-center
          - if @update_user_invoices_job.run_at < Time.now
            %strong In Progress
            %br
            Started at:
          - else
            %strong Queued
            %br
            Scheduled for:
          = @update_user_invoices_job.run_at
      - else
        %p.explanation
          Use this button to immediately update invoices for the month to date for each enterprise user in the system. This task can be set up to run automatically every night.


    .six.columns.omega.step.text-center
      = form_for :job, url: main_app.start_job_admin_accounts_and_billing_settings_path, method: :post do |f|
        = f.hidden_field :name, value: "finalize_user_invoices"
        -# = f.select :start, options_for_select(month_options), {}, class: "fullwidth select2"
        .form-buttons{"data-hook" => "buttons"}
          = button "Finalise User Invoices", "icon-ok-sign button fullwidth", :submit, disabled: @finalize_user_invoices_job.present?

      %br

      - if @finalize_user_invoices_job
        %p.text-center
          - if @finalize_user_invoices_job.run_at < Time.now
            %strong In Progress
            %br
            Started at:
          - else
            %strong Queued
            %br
            Scheduled for:
          = @finalize_user_invoices_job.run_at
      - else
        %p.explanation
          Use this button to finalize all invoices in the system for the previous calendar month. This task can be set up to run automatically once a month.
